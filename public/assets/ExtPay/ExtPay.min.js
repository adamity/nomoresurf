export var ExtPay=function(){"use strict";"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var e,s,r=(e=function(e,s){"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self&&self,function(e){if("undefined"==typeof browser||Object.getPrototypeOf(browser)!==Object.prototype){const s="The message port closed before a response was received.",r=e=>{const r={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(0===Object.keys(r).length)throw new Error("api-metadata.json has not been included in browser-polyfill");class n extends WeakMap{constructor(e,s){super(s),this.createItem=e}get(e){return this.has(e)||this.set(e,this.createItem(e)),super.get(e)}}const t=e=>e&&"object"==typeof e&&"function"==typeof e.then,a=(s,r)=>(...n)=>{e.runtime.lastError?s.reject(e.runtime.lastError):r.singleCallbackArg||n.length<=1&&!1!==r.singleCallbackArg?s.resolve(n[0]):s.resolve(n)},i=e=>1==e?"argument":"arguments",o=(e,s)=>function(r,...n){if(n.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${i(s.minArgs)} for ${e}(), got ${n.length}`);if(n.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${i(s.maxArgs)} for ${e}(), got ${n.length}`);return new Promise(((t,i)=>{if(s.fallbackToNoCallback)try{r[e](...n,a({resolve:t,reject:i},s))}catch(a){r[e](...n),s.fallbackToNoCallback=!1,s.noCallback=!0,t()}else s.noCallback?(r[e](...n),t()):r[e](...n,a({resolve:t,reject:i},s))}))},g=(e,s,r)=>new Proxy(s,{apply:(s,n,t)=>r.call(n,e,...t)});let m=Function.call.bind(Object.prototype.hasOwnProperty);const A=(e,s={},r={})=>{let n=Object.create(null),t={has:(s,r)=>r in e||r in n,get(t,a,i){if(a in n)return n[a];if(!(a in e))return;let l=e[a];if("function"==typeof l)if("function"==typeof s[a])l=g(e,e[a],s[a]);else if(m(r,a)){let s=o(a,r[a]);l=g(e,e[a],s)}else l=l.bind(e);else if("object"==typeof l&&null!==l&&(m(s,a)||m(r,a)))l=A(l,s[a],r[a]);else{if(!m(r,"*"))return Object.defineProperty(n,a,{configurable:!0,enumerable:!0,get:()=>e[a],set(s){e[a]=s}}),l;l=A(l,s[a],r["*"])}return n[a]=l,l},set:(s,r,t,a)=>(r in n?n[r]=t:e[r]=t,!0),defineProperty:(e,s,r)=>Reflect.defineProperty(n,s,r),deleteProperty:(e,s)=>Reflect.deleteProperty(n,s)},a=Object.create(e);return new Proxy(a,t)},l=e=>({addListener(s,r,...n){s.addListener(e.get(r),...n)},hasListener:(s,r)=>s.hasListener(e.get(r)),removeListener(s,r){s.removeListener(e.get(r))}});let c=!1;const x=new n((e=>"function"!=typeof e?e:function(s,r,n){let a,i,o=!1,g=new Promise((e=>{a=function(s){c||(c=!0),o=!0,e(s)}}));try{i=e(s,r,a)}catch(e){i=Promise.reject(e)}const m=!0!==i&&t(i);if(!0!==i&&!m&&!o)return!1;const A=e=>{e.then((e=>{n(e)}),(e=>{let s;s=e&&(e instanceof Error||"string"==typeof e.message)?e.message:"An unexpected error occurred",n({__mozWebExtensionPolyfillReject__:!0,message:s})})).catch((e=>{}))};return A(m?i:g),!0})),u=({reject:r,resolve:n},t)=>{e.runtime.lastError?e.runtime.lastError.message===s?n():r(e.runtime.lastError):t&&t.__mozWebExtensionPolyfillReject__?r(new Error(t.message)):n(t)},d=(e,s,r,...n)=>{if(n.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${i(s.minArgs)} for ${e}(), got ${n.length}`);if(n.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${i(s.maxArgs)} for ${e}(), got ${n.length}`);return new Promise(((e,s)=>{const t=u.bind(null,{resolve:e,reject:s});n.push(t),r.sendMessage(...n)}))},p={runtime:{onMessage:l(x),onMessageExternal:l(x),sendMessage:d.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:d.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},f={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return r.privacy={network:{"*":f},services:{"*":f},websites:{"*":f}},A(e,p,r)};if("object"!=typeof chrome||!chrome||!chrome.runtime||!chrome.runtime.id)throw new Error("This script should only be loaded in a browser extension.");e.exports=r(chrome)}else e.exports=browser}(e)},e(s={exports:{}},s.exports),s.exports);return"undefined"!=typeof window&&window.addEventListener("message",(e=>{"https://extensionpay.com"===e.origin&&e.source==window&&("fetch-user"!==e.data&&"trial-start"!==e.data||r.runtime.sendMessage(e.data))}),!1),function(e){const s="https://extensionpay.com",n=`${s}/extension/${e}`;function t(e){return new Promise((s=>setTimeout(s,e)))}async function a(e){try{return await r.storage.sync.get(e)}catch(s){return await r.storage.local.get(e)}}async function i(e){try{return await r.storage.sync.set(e)}catch(s){return await r.storage.local.set(e)}}r.management&&r.management.getSelf().then((async e=>{if(!e.permissions.includes("storage")){var s=e.hostPermissions.concat(e.permissions);throw`ExtPay Setup Error: please include the "storage" permission in manifest.json["permissions"] or else ExtensionPay won't work correctly.\n\nYou can copy and paste this to your manifest.json file to fix this error:\n\n"permissions": [\n    ${s.map((e=>`"    ${e}"`)).join(",\n")}${s.length>0?",":""}\n    "storage"\n]\n`}})),a(["extensionpay_installed_at","extensionpay_user"]).then((async e=>{if(e.extensionpay_installed_at)return;const s=e.extensionpay_user,r=s?s.installedAt:(new Date).toISOString();await i({extensionpay_installed_at:r})}));const o=[],g=[];async function m(){var e,t={};if(r.management)e=await r.management.getSelf();else{if(!r.runtime)throw"ExtPay needs to be run in a browser extension context";if(!(e=await r.runtime.sendMessage("extpay-extinfo"))){e={installType:!("update_url"in r.runtime.getManifest())?"development":"normal"}}}"development"==e.installType&&(t.development=!0);const a=await fetch(`${n}/api/new-key`,{method:"POST",headers:{Accept:"application/json","Content-type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw a.status,`${s}/home`;const o=await a.json();return await i({extensionpay_api_key:o}),o}async function A(){const e=await a(["extensionpay_api_key"]);return e.extensionpay_api_key?e.extensionpay_api_key:null}const l=/^\d\d\d\d-\d\d-\d\dT/;async function c(){var e=await a(["extensionpay_user","extensionpay_installed_at"]);const s=await A();if(!s)return{paid:!1,paidAt:null,installedAt:e.extensionpay_installed_at?new Date(e.extensionpay_installed_at):new Date,trialStartedAt:null};const r=await fetch(`${n}/api/user?api_key=${s}`,{method:"GET",headers:{Accept:"application/json"}});if(!r.ok)throw"ExtPay error while fetching user: "+await r.text();const t=await r.json(),m={};for(var[c,x]of Object.entries(t))x&&x.match&&x.match(l)&&(x=new Date(x)),m[c]=x;return m.installedAt=new Date(e.extensionpay_installed_at),m.paidAt&&(!e.extensionpay_user||e.extensionpay_user&&!e.extensionpay_user.paidAt)&&o.forEach((e=>e(m))),m.trialStartedAt&&(!e.extensionpay_user||e.extensionpay_user&&!e.extensionpay_user.trialStartedAt)&&g.forEach((e=>e(m))),await i({extensionpay_user:t}),m}async function x(e,s,n){if(r.windows&&r.windows.create){const t=await r.windows.getCurrent(),a=Math.round(.5*(t.width-s)+t.left),i=Math.round(.5*(t.height-n)+t.top);try{r.windows.create({url:e,type:"popup",focused:!0,width:s,height:n,left:a,top:i})}catch(t){r.windows.create({url:e,type:"popup",width:s,height:n,left:a,top:i})}}else window.open(e,null,`toolbar=no,location=no,directories=no,status=no,menubar=no,width=${s},height=${n},left=450`)}var u=!1;return{getUser:function(){return c()},onPaid:{addListener:function(e){const n=`"content_scripts": [\n                {\n            "matches": ["${s}/*"],\n            "js": ["ExtPay.js"],\n            "run_at": "document_start"\n        }]`,t=r.runtime.getManifest();if(!t.content_scripts)throw`ExtPay setup error: To use the onPaid callback handler, please include ExtPay as a content script in your manifest.json. You can copy the example below into your manifest.json or check the docs: https://github.com/Glench/ExtPay#2-configure-your-manifestjson\n\n        ${n}`;const a=t.content_scripts.find((e=>e.matches.includes(s.replace(":3000","")+"/*")));if(!a)throw`ExtPay setup error: To use the onPaid callback handler, please include ExtPay as a content script in your manifest.json matching "${s}/*". You can copy the example below into your manifest.json or check the docs: https://github.com/Glench/ExtPay#2-configure-your-manifestjson\n\n        ${n}`;if(!a.run_at||"document_start"!==a.run_at)throw`ExtPay setup error: To use the onPaid callback handler, please make sure the ExtPay content script in your manifest.json runs at document start. You can copy the example below into your manifest.json or check the docs: https://github.com/Glench/ExtPay#2-configure-your-manifestjson\n\n        ${n}`;o.push(e)}},openPaymentPage:async function(){x(await async function(){var e=await A();return e||(e=await m()),`${n}?api_key=${e}`}(),500,800)},openTrialPage:async function(e){var s=await A();s||(s=await m());var r=`${n}/trial?api_key=${s}`;e&&(r+=`&period=${e}`),x(r,500,650)},openLoginPage:async function(){var e=await A();e||(e=await m()),x(`${n}/reactivate?api_key=${e}`,500,800)},onTrialStarted:{addListener:function(e){g.push(e)}},startBackground:function(){r.runtime.onMessage.addListener((function(e,s,n){if("fetch-user"==e)!async function(){if(!u){u=!0;for(var e=await c(),s=0;s<120;++s){if(e.paidAt)return u=!1,e;await t(1e3),e=await c()}u=!1}}();else if("trial-start"==e)c();else if("extpay-extinfo"==e&&r.management)return r.management.getSelf()}))}}}}();