import{getBlocklist,getIsWhitelist,generateMathProblem,validateURL}from"./controller.js";let tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),tooltipList=tooltipTriggerList.map((function(e){return new bootstrap.Tooltip(e)}));const addWebsiteBtn=document.getElementById("addWebsiteBtn"),websiteInput=document.getElementById("websiteInput"),unblockQuestionObject=document.getElementsByClassName("unblockQuestionObject"),confirmUnblockObject=document.getElementsByClassName("confirmUnblockObject"),confirmUnblockBtn=document.getElementById("confirmUnblockBtn"),unblockQuestion=document.getElementById("unblockQuestion"),answerInput=document.getElementById("answerInput"),alertSuccessMessage=document.getElementById("alertSuccessMessage"),alertWarningMessage=document.getElementById("alertWarningMessage");let blocklist=[],isWhitelist=!1,correctAnswer=null,progress=0;function renderBlocklist(e){let t=document.getElementById("blocklistContainer"),s=document.getElementById("blocklistEmpty"),n=document.getElementsByClassName("btn-delete"),l="";for(let t=0;t<e.length;t++)l+='<div class="d-flex align-items-center user-select-none">',l+=`<img src="http://www.google.com/s2/favicons?domain=${e[t]}" class="img-thumbnail" alt="..." style="height: 30px;">`,l+=`<p class="m-0 ms-2">${e[t]}</p>`,l+=`<button type="button" class="btn btn-sm btn-light border btn-delete ms-auto" data-item="${e[t]}" data-bs-toggle="modal" data-bs-target="#unblockModal"><i class="bi bi-trash3"></i></button>`,l+="</div>",l+="<hr>";t.innerHTML=l,l?toggleObject(s,t,"id"):toggleObject(t,s,"id");for(let e=0;e<n.length;e++)n[e].addEventListener("click",(function(){let e=this.getAttribute("data-item");document.getElementById("selectedURL").value=e,document.getElementById("selectedURLText").innerText=e,toggleObject(confirmUnblockObject,unblockQuestionObject,"class"),resetProgress(),correctAnswer=setUnblockQuestion()}))}function updateProgress(e){let t=33.3333333333*e;document.querySelector(".progress-bar").style.width=t+"%"}function resetProgress(){answerInput.value="",correctAnswer=null,progress=0,updateProgress(progress)}function setUnblockQuestion(){let e=generateMathProblem(2);return unblockQuestion.innerText=e[0],e[1]}function toggleObject(e,t,s){if("id"==s)e.style.display="none",t.style.display="block";else if("class"==s){for(let t=0;t<e.length;t++)e[t].classList.add("d-none");for(let e=0;e<t.length;e++)t[e].classList.remove("d-none")}}async function init(){blocklist=await getBlocklist(),isWhitelist=await getIsWhitelist(),confirmUnblockBtn.disabled=!0,renderBlocklist(blocklist),toggleObject(confirmUnblockObject,unblockQuestionObject,"class")}init(),addWebsiteBtn.addEventListener("click",(async()=>{addWebsiteBtn.disabled=!0;let e=websiteInput.value;e.includes("://")&&(e=e.split("://")[1]),e=await validateURL(e),blocklist.includes(e)?(alertWarningMessage.innerText="This site is already blocked!",alertWarningMessage.classList.add("show"),setTimeout((()=>{alertWarningMessage.classList.remove("show")}),3e3)):e?(blocklist.push(e),chrome.storage.sync.set({blocklist:blocklist}),renderBlocklist(blocklist),websiteInput.value="",alertSuccessMessage.innerText="Site added to blocklist!",alertSuccessMessage.classList.add("show"),setTimeout((()=>{alertSuccessMessage.classList.remove("show")}),3e3)):(alertWarningMessage.innerText="Invalid URL",alertWarningMessage.classList.add("show"),setTimeout((()=>{alertWarningMessage.classList.remove("show")}),3e3)),addWebsiteBtn.disabled=!1})),websiteInput.addEventListener("keyup",(e=>{13===e.keyCode&&(e.preventDefault(),addWebsiteBtn.click())})),document.getElementById("submitAnswerBtn").addEventListener("click",(()=>{if(answerInput.value==correctAnswer)if(answerInput.value="",updateProgress(++progress),progress>2){toggleObject(unblockQuestionObject,confirmUnblockObject,"class"),confirmUnblockBtn.disabled=!0,confirmUnblockBtn.innerText="Unblock (5)";let e=5,t=setInterval((()=>{confirmUnblockBtn.innerText=`Unblock (${--e})`}),1e3);setTimeout((()=>{clearInterval(t),confirmUnblockBtn.disabled=!1,confirmUnblockBtn.innerText="Unblock"}),5e3)}else correctAnswer=setUnblockQuestion();else unblockQuestion.style.animation="shake 0.3s 1",setTimeout((()=>{unblockQuestion.style.animation=""}),300)})),confirmUnblockBtn.addEventListener("click",(()=>{let e=blocklist.indexOf(document.getElementById("selectedURL").value);blocklist.splice(e,1),chrome.storage.sync.set({blocklist:blocklist}),confirmUnblockBtn.disabled=!0,alertSuccessMessage.innerText="Site removed from blocklist!",alertSuccessMessage.classList.add("show"),setTimeout((()=>{alertSuccessMessage.classList.remove("show")}),3e3),resetProgress(),renderBlocklist(blocklist)}));