import{getBlocklist,getIsWhitelist,generateMathProblem,validateURL}from"./controller.min.js";let tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),tooltipList=tooltipTriggerList.map((function(e){return new bootstrap.Tooltip(e)}));const addWebsiteBtn=document.getElementById("addWebsiteBtn"),websiteInput=document.getElementById("websiteInput"),whitelistMode=document.getElementById("whitelistMode"),unblockQuestionObject=document.getElementsByClassName("unblockQuestionObject"),confirmUnblockObject=document.getElementsByClassName("confirmUnblockObject"),unblockQuestion=document.getElementById("unblockQuestion"),answerInput=document.getElementById("answerInput"),alertSuccessMessage=document.getElementById("alertSuccessMessage"),alertWarningMessage=document.getElementById("alertWarningMessage");let blocklist=[],isWhitelist=!1,correctAnswer=null,progress=0;function renderBlocklist(e){let t=document.getElementById("blocklistContainer"),s=document.getElementById("blocklistEmpty"),l=document.getElementsByClassName("btn-delete"),n="";for(let t=0;t<e.length;t++)n+='<div class="d-flex align-items-center user-select-none">',n+=`<img src="http://www.google.com/s2/favicons?domain=${e[t]}" class="img-thumbnail" alt="..." style="height: 30px;">`,n+=`<p class="m-0 ms-2">${e[t]}</p>`,n+=`<button type="button" class="btn btn-sm btn-light border btn-delete ms-auto" data-item="${e[t]}" data-bs-toggle="modal" data-bs-target="#unblockModal"><i class="bi bi-trash3"></i></button>`,n+="</div>",n+="<hr>";t.innerHTML=n,n?toggleObject(s,t,"id"):toggleObject(t,s,"id");for(let e=0;e<l.length;e++)l[e].addEventListener("click",(function(){let e=this.getAttribute("data-item");document.getElementById("selectedURL").value=e,document.getElementById("selectedURLText").innerText=e,toggleObject(confirmUnblockObject,unblockQuestionObject,"class"),resetProgress(),correctAnswer=setUnblockQuestion()}))}function updateProgress(e){let t=33.3333333333*e;document.querySelector(".progress-bar").style.width=t+"%"}function resetProgress(){answerInput.value="",correctAnswer=null,progress=0,updateProgress(progress)}function setUnblockQuestion(){let e=generateMathProblem(2);return unblockQuestion.innerText=e[0],e[1]}function toggleObject(e,t,s){if("id"==s)e.style.display="none",t.style.display="block";else if("class"==s){for(let t=0;t<e.length;t++)e[t].classList.add("d-none");for(let e=0;e<t.length;e++)t[e].classList.remove("d-none")}}async function init(){blocklist=await getBlocklist(),isWhitelist=await getIsWhitelist(),isWhitelist&&(whitelistMode.checked=!0),renderBlocklist(blocklist),toggleObject(confirmUnblockObject,unblockQuestionObject,"class")}init(),addWebsiteBtn.addEventListener("click",(async()=>{addWebsiteBtn.disabled=!0;let e=websiteInput.value;e.includes("://")&&(e=e.split("://")[1]),e=await validateURL(e),blocklist.includes(e)?(alertWarningMessage.innerText="This site is already blocked!",alertWarningMessage.classList.add("show"),setTimeout((()=>{alertWarningMessage.classList.remove("show")}),3e3)):e?(blocklist.push(e),chrome.storage.sync.set({blocklist:blocklist}),renderBlocklist(blocklist),websiteInput.value="",alertSuccessMessage.innerText="Site added to blocklist!",alertSuccessMessage.classList.add("show"),setTimeout((()=>{alertSuccessMessage.classList.remove("show")}),3e3)):(alertWarningMessage.innerText="Invalid URL",alertWarningMessage.classList.add("show"),setTimeout((()=>{alertWarningMessage.classList.remove("show")}),3e3)),addWebsiteBtn.disabled=!1})),websiteInput.addEventListener("keyup",(e=>{13===e.keyCode&&(e.preventDefault(),addWebsiteBtn.click())})),whitelistMode.addEventListener("change",(()=>{chrome.storage.sync.set({isWhitelist:whitelistMode.checked})})),document.getElementById("submitAnswerBtn").addEventListener("click",(()=>{answerInput.value==correctAnswer?(answerInput.value="",updateProgress(++progress),progress>2?toggleObject(unblockQuestionObject,confirmUnblockObject,"class"):correctAnswer=setUnblockQuestion()):(unblockQuestion.style.animation="shake 0.3s 1",setTimeout((()=>{unblockQuestion.style.animation=""}),300))})),document.getElementById("confirmUnblockBtn").addEventListener("click",(()=>{let e=blocklist.indexOf(document.getElementById("selectedURL").value);blocklist.splice(e,1),chrome.storage.sync.set({blocklist:blocklist}),alertSuccessMessage.innerText="Site removed from blocklist!",alertSuccessMessage.classList.add("show"),setTimeout((()=>{alertSuccessMessage.classList.remove("show")}),3e3),resetProgress(),renderBlocklist(blocklist)}));