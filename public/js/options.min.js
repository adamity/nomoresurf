import{getBlocklist,getIsWhitelist,generateMathProblem,validateURL}from"./controller.min.js";let tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),tooltipList=tooltipTriggerList.map((function(e){return new bootstrap.Tooltip(e)}));const addWebsiteBtn=document.getElementById("addWebsiteBtn"),websiteInput=document.getElementById("websiteInput"),whitelistMode=document.getElementById("whitelistMode"),unblockQuestionObject=document.getElementsByClassName("unblockQuestionObject"),confirmUnblockObject=document.getElementsByClassName("confirmUnblockObject"),confirmUnblockBtn=document.getElementById("confirmUnblockBtn"),unblockQuestion=document.getElementById("unblockQuestion"),answerInput=document.getElementById("answerInput"),isToggleWhitelist=document.getElementById("isToggleWhitelist"),whitelistState=document.getElementById("whitelistState"),unblockModal=new bootstrap.Modal(document.getElementById("unblockModal")),alertMessage=document.getElementById("alertMessage"),unblockModalText=document.getElementById("unblockModalText"),confirmText=document.getElementById("confirmText"),submitAnswerBtn=document.getElementById("submitAnswerBtn"),listText=document.getElementById("listText"),addedSiteHead=document.getElementById("addedSiteHead"),addedSiteLead=document.getElementById("addedSiteLead"),selectedURL=document.getElementById("selectedURL");let blocklist=[],isWhitelist=!1,correctAnswer=null,progress=0;function renderView(e,t){let s=document.getElementById("blocklistContainer"),i=document.getElementById("blocklistEmpty"),l=document.getElementsByClassName("btn-delete"),n="";for(let t=0;t<e.length;t++)n+='<div class="d-flex align-items-center user-select-none">',n+=`<img src="http://www.google.com/s2/favicons?domain=${e[t]}" class="img-thumbnail" alt="..." style="height: 30px;">`,n+=`<p class="m-0 ms-2">${e[t]}</p>`,n+=`<button type="button" class="btn btn-sm btn-light border btn-delete ms-auto" data-item="${e[t]}"><i class="bi bi-trash3"></i></button>`,n+="</div>",n+="<hr>";s.innerHTML=n,n?toggleVisibility(i,s,"id"):toggleVisibility(s,i,"id");for(let e=0;e<l.length;e++)l[e].addEventListener("click",(async function(){let e=this.getAttribute("data-item");if(t){let t=updateWebsiteList(e,!1);confirmUnblockBtn.disabled=!0,showAlertMessage((await t).message)}else isToggleWhitelist.checked=!1,selectedURL.value=e,unblockModalText.innerText="Unblock Website",confirmText.innerText=`Do you really want to unblock ${e}`,toggleVisibility(confirmUnblockObject,unblockQuestionObject,"class"),resetProgress(),setUnblockQuestion(),unblockModal.show()}));t?(whitelistMode.checked=!0,listText.innerText="Whitelist",addedSiteHead.innerText="No whitelisted websites",addedSiteLead.innerText="Add websites to the whitelist to allow access."):(listText.innerText="Block List",addedSiteHead.innerText="No blocked websites",addedSiteLead.innerText="Add websites to the blocklist to prevent access.")}async function toggleWhitelist(e){let t={success:!0,message:""};return chrome.storage.sync.set({isWhitelist:e}),whitelistMode.checked=e,isWhitelist=e,t.message=`Whitelist mode ${e?"enabled":"disabled"}!`,renderView(blocklist,isWhitelist),t}async function updateWebsiteList(e,t=!0){let s={success:!1,message:""};if(t)e.includes("://")&&(e=e.split("://")[1]),e=await validateURL(e),blocklist.includes(e)?s.message=`This site is already ${isWhitelist?"whitelisted":"blocked"}!`:e?(blocklist.push(e),chrome.storage.sync.set({blocklist:blocklist}),websiteInput.value="",s.success=!0,s.message=`Site added to ${isWhitelist?"whitelist":"blocklist"}!`):s.message="Invalid URL";else{let t=blocklist.indexOf(e);blocklist.splice(t,1),s.success=!0,s.message=`Site removed from ${isWhitelist?"whitelist":"blocklist"}!`}return chrome.storage.sync.set({blocklist:blocklist}),renderView(blocklist,isWhitelist),s}function showAlertMessage(e,t=!0){alertMessage.classList.remove("alert-success","alert-warning"),alertMessage.classList.add(t?"alert-success":"alert-warning"),alertMessage.innerText=e,alertMessage.classList.add("show"),setTimeout((()=>{alertMessage.classList.remove("show")}),3e3)}function updateProgress(e){let t=33.3333333333*e;document.querySelector(".progress-bar").style.width=t+"%"}function resetProgress(){answerInput.value="",correctAnswer=null,progress=0,updateProgress(progress)}function setUnblockQuestion(){let e=generateMathProblem(2);unblockQuestion.innerText=e[0],correctAnswer=e[1]}function toggleVisibility(e,t,s){if("id"==s)e.style.display="none",t.style.display="block";else if("class"==s){for(let t=0;t<e.length;t++)e[t].classList.add("d-none");for(let e=0;e<t.length;e++)t[e].classList.remove("d-none")}}async function init(){blocklist=await getBlocklist(),isWhitelist=await getIsWhitelist(),confirmUnblockBtn.disabled=!0,renderView(blocklist,isWhitelist),toggleVisibility(confirmUnblockObject,unblockQuestionObject,"class")}init(),addWebsiteBtn.addEventListener("click",(async()=>{if(addWebsiteBtn.disabled=!0,isWhitelist)isToggleWhitelist.checked=!1,selectedURL.value=websiteInput.value,unblockModalText.innerText="Add to Whitelist",confirmText.innerText=`Do you really want to add ${selectedURL.value} to the whitelist?`,toggleVisibility(confirmUnblockObject,unblockQuestionObject,"class"),resetProgress(),setUnblockQuestion(),unblockModal.show();else{let e=updateWebsiteList(websiteInput.value);(await e).success?showAlertMessage((await e).message):showAlertMessage((await e).message,!1)}addWebsiteBtn.disabled=!1})),websiteInput.addEventListener("keyup",(e=>{13===e.keyCode&&(e.preventDefault(),addWebsiteBtn.click())})),whitelistMode.addEventListener("click",(e=>{e.preventDefault(),isToggleWhitelist.checked=!0,whitelistState.checked=whitelistMode.checked,unblockModalText.innerText="Whitelist Mode",confirmText.innerText=`Do you really want to ${whitelistMode.checked?"enable":"disable"} whitelist mode?`,toggleVisibility(confirmUnblockObject,unblockQuestionObject,"class"),resetProgress(),setUnblockQuestion(),unblockModal.show()})),submitAnswerBtn.addEventListener("click",(()=>{if(answerInput.value==correctAnswer)if(answerInput.value="",updateProgress(++progress),progress>2){toggleVisibility(unblockQuestionObject,confirmUnblockObject,"class"),confirmUnblockBtn.disabled=!0,confirmUnblockBtn.innerText="Confirm (5)";let e=5,t=setInterval((()=>{confirmUnblockBtn.innerText=`Confirm (${--e})`}),1e3);setTimeout((()=>{clearInterval(t),confirmUnblockBtn.disabled=!1,confirmUnblockBtn.innerText="Confirm"}),5e3)}else setUnblockQuestion();else unblockQuestion.style.animation="shake 0.3s 1",setTimeout((()=>{unblockQuestion.style.animation=""}),300)})),confirmUnblockBtn.addEventListener("click",(async()=>{let e={};e=isToggleWhitelist.checked?toggleWhitelist(whitelistState.checked):isWhitelist?updateWebsiteList(selectedURL.value):updateWebsiteList(selectedURL.value,!1),confirmUnblockBtn.disabled=!0,showAlertMessage((await e).message),resetProgress()}));